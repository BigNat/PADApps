INDEX
=====

commands\clear_all_pipe_highlights.py
commands\clear_pipe_highlights.py
commands\export_sheets_to_cad.py
commands\export_sheets_to_pdf.py
commands\export_views_to_nwc.py
commands\highlight_pipes.py
commands\open_view_by_id.py
commands\select_elements.py
commands\select_pipes_in_current_view.py
commands\set_pipe_il.py
commands\test_command.py
CommandWatcherHelper.py
requests\get_3d_views.py
requests\get_active_view.py
requests\get_all_views.py
requests\get_highlighted_pipes.py
requests\get_model_path.py
requests\get_pipe_elevations.py
requests\get_pipe_ids.py
requests\get_pipe_info.py
requests\get_pipes_with_tags.py
requests\get_sheet_data.py
──────────────────────────────────────────────────────────────────────
################################################################################
### commands\clear_all_pipe_highlights.py
################################################################################
# -*- coding: utf-8 -*-
import os
import json
import traceback

import Autodesk.Revit.DB as DB
from Autodesk.Revit.DB import ElementId, OverrideGraphicSettings, Transaction
from Autodesk.Revit.DB.Plumbing import Pipe

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")


def run(uiapp, data, log):
    """
    Removes ALL highlight overrides for ALL pipes visible in the active view.
    """
    try:
        uidoc = uiapp.ActiveUIDocument
        doc = uidoc.Document
        view = uidoc.ActiveView

        log("CLEAR ALL HIGHLIGHTS: scanning active view...")

        collector = DB.FilteredElementCollector(doc, view.Id).OfClass(Pipe)
        pipes = list(collector)

        ogs_clear = OverrideGraphicSettings()

        t = Transaction(doc, "Clear All Pipe Highlights")
        t.Start()

        for p in pipes:
            try:
                view.SetElementOverrides(p.Id, ogs_clear)
            except Exception as inner:
                log(" - ERROR clearing {0}: {1}".format(p.Id.IntegerValue, inner))

        t.Commit()

        result = {
            "status": "ok",
            "cleared_count": len(pipes)
        }

        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)

        with open(RESPONSE_PATH, "w") as f:
            json.dump(result, f, indent=2)

        log("CLEAR ALL HIGHLIGHTS: completed for {0} pipes".format(len(pipes)))

    except Exception as e:
        log("Error in clear_all_pipe_highlights: {0}".format(e))
        log(traceback.format_exc())

        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)

        with open(RESPONSE_PATH, "w") as f:
            json.dump({"error": str(e)}, f, indent=2)

################################################################################
### commands\clear_pipe_highlights.py
################################################################################
# -*- coding: utf-8 -*-
import os
import json
import traceback

import Autodesk.Revit.DB as DB
from Autodesk.Revit.DB import ElementId, OverrideGraphicSettings, Transaction

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")


def run(uiapp, data, log):
    """
    Clears highlight overrides for a list of pipe IDs.
    """
    try:
        uidoc = uiapp.ActiveUIDocument
        doc = uidoc.Document
        view = uidoc.ActiveView

        ids = data.get("ids", [])

        if not ids:
            raise Exception("No pipe IDs provided to clear highlights.")

        log("CLEAR HIGHLIGHT: removing overrides for pipes: {0}".format(ids))

        # Convert to ElementId list
        element_ids = [ElementId(int(x)) for x in ids]

        ogs_clear = OverrideGraphicSettings()

        t = Transaction(doc, "Clear Pipe Highlights")
        t.Start()

        for eid in element_ids:
            try:
                view.SetElementOverrides(eid, ogs_clear)
            except Exception as inner:
                log(" - ERROR clearing {0}: {1}".format(eid.IntegerValue, inner))

        t.Commit()

        # JSON Response
        result = {
            "status": "ok",
            "cleared_ids": ids,
            "count": len(ids)
        }

        with open(RESPONSE_PATH, "w") as f:
            json.dump(result, f, indent=2)

        log("CLEAR HIGHLIGHT: completed for {0} pipe(s)".format(len(ids)))

    except Exception as e:
        log("Error in clear_pipe_highlights: {0}".format(e))
        log(traceback.format_exc())
        with open(RESPONSE_PATH, "w") as f:
            json.dump({"error": str(e)}, f, indent=2)

################################################################################
### commands\export_sheets_to_cad.py
################################################################################
# -*- coding: utf-8 -*-
import os, json, clr
from pyrevit import forms
from Autodesk.Revit.DB import (
    FilteredElementCollector,
    BuiltInCategory,
    ViewSheet,
    DWGExportOptions,
    DXFExportOptions,
    ElementId
)

# Add System.Collections.Generic for List[ElementId]
clr.AddReference("System")
from System.Collections.Generic import List

# --------------------------------------------------------------------------
# RESPONSE PATH
# --------------------------------------------------------------------------
REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")


def write_response(payload, log):
    """Write response.json for DWG export (success or error)."""
    try:
        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)
        with open(RESPONSE_PATH, "w") as f:
            json.dump(payload, f, indent=2)
        log("DWG response.json written.")
    except Exception as e:
        log("ERROR writing DWG response.json: {}".format(e))


# --------------------------------------------------------------------------
# MAIN ENTRY POINT
# --------------------------------------------------------------------------
def run(uiapp, data, log):
    """Exports selected Revit sheets to DWG or DXF and writes response.json."""
    try:
        doc = uiapp.ActiveUIDocument.Document

        # Extract parameters
        sheet_ids = data.get("sheet_ids", [])
        cad_format = data.get("cad_format", "dwg").lower()
        export_path = data.get("path", r"C:\PADApps\RevitPAD\ExportsDWG")

        if not os.path.exists(export_path):
            os.makedirs(export_path)

        log("Starting export_sheets_to_cad -> {}".format(export_path))
        log("Format: {} | Sheets: {}".format(cad_format, len(sheet_ids)))

        # Choose export options
        if cad_format == "dxf":
            options = DXFExportOptions()
        else:
            options = DWGExportOptions()

        # Options cleanup & safety
        try: options.ExportViewsAsExternalReferences = False
        except: pass
        try: options.MergedViews = True
        except: pass
        try: options.SharedCoords = False
        except: pass
        try: options.ExportingAreas = False
        except: pass

        # Collect sheets
        all_sheets = FilteredElementCollector(doc).OfCategory(BuiltInCategory.OST_Sheets)

        if not sheet_ids:
            export_sheets = all_sheets
        else:
            export_sheets = [s for s in all_sheets if s.Id.IntegerValue in sheet_ids]

        if not export_sheets:
            msg = "No matching sheets found for DWG export."
            log(msg)
            write_response({"error": msg}, log)
            return

        exported = []

        # ----------------------------------------------------------------------
        # EXPORT LOOP
        # ----------------------------------------------------------------------
        for sheet in export_sheets:
            try:
                sheetnum = sheet.SheetNumber
                sheetname = sheet.Name

                # Safe filename
                combined = "{}_{}".format(sheetnum, sheetname)
                safe_name = "".join([c for c in combined if c.isalnum() or c in ("_", "-")])

                views = List[ElementId]([sheet.Id])
                result = doc.Export(export_path, safe_name, views, options)

                if result:
                    file_path = os.path.join(export_path, safe_name + "." + cad_format)
                    exported.append(file_path)
                    log("Exported: {}".format(file_path))

            except Exception as e:
                log("Failed to export sheet {}: {}".format(sheet.SheetNumber, e))

        # ----------------------------------------------------------------------
        # WRITE SUCCESS RESPONSE
        # ----------------------------------------------------------------------
        payload = {
            "status": "ok",
            "exported_count": len(exported),
            "exported_files": exported
        }

        write_response(payload, log)
        log("DWG Export complete: {} files".format(len(exported)))

    except Exception as e:
        err = "DWG Export error: {}".format(e)
        log(err)
        write_response({"error": err}, log)

################################################################################
### commands\export_sheets_to_pdf.py
################################################################################
# -*- coding: utf-8 -*-
import os
import json
from pyrevit import forms
from Autodesk.Revit.DB import (
    FilteredElementCollector,
    BuiltInCategory,
    PrintRange
)

PDF_DRIVER = "PDFCreator"

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")


def write_response(payload, log):
    """Write ONLY error responses from Revit."""
    try:
        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)
        with open(RESPONSE_PATH, "w") as f:
            json.dump(payload, f, indent=2)
        log("Response.json written.")
    except Exception as e:
        log("ERROR writing response.json: {}".format(e))


def run(uiapp, data, log):
    """
    Export sheets to PDF.
    NOTE:
        • NO success response is written.
        • BlueTree will detect, move, and write the final response.
    """
    try:
        uidoc = uiapp.ActiveUIDocument
        doc = uidoc.Document

        # ---------------------------------------------------
        # Incoming request data
        # ---------------------------------------------------
        sheet_ids = data.get("sheet_ids", [])
        export_path = data.get("path", r"C:\PADApps\RevitPAD\ExportsPDF")

        if not os.path.exists(export_path):
            os.makedirs(export_path)

        if not sheet_ids:
            msg = "No sheet_ids passed to export_sheets_to_pdf"
            log(msg)
            write_response({"error": msg}, log)
            return

        log("PRINT-CURRENT-WINDOW mode started")
        log("Sheet IDs received: {}".format(sheet_ids))

        # ---------------------------------------------------
        # Collect matching sheets
        # ---------------------------------------------------
        collector = (
            FilteredElementCollector(doc)
            .OfCategory(BuiltInCategory.OST_Sheets)
            .WhereElementIsNotElementType()
        )

        sheets = [s for s in collector if s.Id.IntegerValue in sheet_ids]

        if not sheets:
            msg = "No valid sheets found for provided IDs."
            log(msg)
            write_response({"error": msg}, log)
            return

        # ---------------------------------------------------
        # Configure PDF print driver
        # ---------------------------------------------------
        pm = doc.PrintManager
        pm.SelectNewPrintDriver(PDF_DRIVER)
        pm.PrintToFile = True
        pm.PrintRange = PrintRange.Current

        # ---------------------------------------------------
        # Loop — one sheet per file
        # (PDFCreator overrides the filename)
        # ---------------------------------------------------
        for sheet in sheets:
            log("→ Activating sheet {}".format(sheet.SheetNumber))

            uidoc.ActiveView = sheet

            num = sheet.SheetNumber
            name = sheet.Name
            combined = "{}_{}".format(num, name)
            safe = "".join([c for c in combined if c.isalnum() or c in ("_", "-")])

            out_file = os.path.join(export_path, safe + ".pdf")
            log("→ Printing to: {}".format(out_file))

            pm.PrintToFileName = out_file
            pm.Apply()
            pm.SubmitPrint()

            log("✔ Printed (PDFCreator may rename): {}".format(out_file))

        # ---------------------------------------------------
        # IMPORTANT:
        # NO SUCCESS RESPONSE WRITTEN HERE.
        # BlueTree detects and moves the files,
        # then generates the REAL response with correct paths.
        # ---------------------------------------------------

    except Exception as e:
        err = "PDF Export error: {}".format(e)
        log(err)
        write_response({"error": err}, log)

################################################################################
### commands\export_views_to_nwc.py
################################################################################
# -*- coding: utf-8 -*-
import os, json, clr
from pyrevit import forms
from Autodesk.Revit.DB import View
from Autodesk.Revit.DB import (
    FilteredElementCollector,
    BuiltInCategory,
    ElementId,
    NavisworksExportOptions,
    NavisworksExportScope,
    NavisworksCoordinates
)

# Add System.Collections.Generic for List[ElementId]
clr.AddReference("System")
from System.Collections.Generic import List

# --------------------------------------------------------------------------
# RESPONSE PATH
# --------------------------------------------------------------------------
REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")


def write_response(payload, log):
    """Write response.json for NWC export (success or error)."""
    try:
        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)
        with open(RESPONSE_PATH, "w") as f:
            json.dump(payload, f, indent=2)
        log("NWC response.json written.")
    except Exception as e:
        log("ERROR writing NWC response.json: {}".format(e))


# --------------------------------------------------------------------------
# MAIN ENTRY POINT
# --------------------------------------------------------------------------
def run(uiapp, data, log):
    """Exports selected Revit views to NWC and writes response.json."""
    try:
        doc = uiapp.ActiveUIDocument.Document

        # Extract parameters
        view_ids = data.get("view_ids", [])
        export_path = data.get("path", r"C:\PADApps\RevitPAD\ExportsNWC")

        if not os.path.exists(export_path):
            os.makedirs(export_path)

        log("Starting export_views_to_nwc -> {}".format(export_path))
        log("Views: {}".format(len(view_ids)))

        # Collect all views
        all_views = FilteredElementCollector(doc).OfClass(View)


        if not view_ids:
            export_views = all_views
        else:
            export_views = [v for v in all_views if v.Id.IntegerValue in view_ids]

        if not export_views:
            msg = "No matching views found for NWC export."
            log(msg)
            write_response({"error": msg}, log)
            return

        exported = []

        # ----------------------------------------------------------------------
        # EXPORT LOOP
        # ----------------------------------------------------------------------
        for view in export_views:
            try:
                viewname = view.Name
                viewnum = view.Id.IntegerValue

                # Safe filename
                combined = "{}_{}".format(viewnum, viewname)
                safe_name = "".join([c for c in combined if c.isalnum() or c in ("_", "-")])

                # Options
                options = NavisworksExportOptions()
                options.ExportScope = NavisworksExportScope.View
                options.ViewId = view.Id
                options.Coordinates = NavisworksCoordinates.Shared

                try:
                    options.ExportLinks = True
                except:
                    pass

                # Export → always add .nwc suffix
                result = doc.Export(export_path, safe_name, options)

                file_path = os.path.join(export_path, safe_name + ".nwc")

                # Navisworks exporter often returns False even on success, so check file existence
                if os.path.exists(file_path):
                    exported.append(file_path)
                    log("Exported: {}".format(file_path))
                else:
                    log("⚠️ Export reported failure (return=False) but file not found.")

            except Exception as e:
                log("Failed to export view {}: {}".format(view.Id.IntegerValue, e))

        # ----------------------------------------------------------------------
        # WRITE SUCCESS RESPONSE
        # ----------------------------------------------------------------------
        payload = {
            "status": "ok",
            "exported_count": len(exported),
            "exported_files": exported
        }

        write_response(payload, log)
        log("NWC Export complete: {} files".format(len(exported)))

    except Exception as e:
        err = "NWC Export error: {}".format(e)
        log(err)
        write_response({"error": err}, log)

################################################################################
### commands\highlight_pipes.py
################################################################################
# -*- coding: utf-8 -*-
import os
import json
import traceback

import Autodesk.Revit.DB as DB
from Autodesk.Revit.DB import ElementId, OverrideGraphicSettings, Color, Transaction


REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")


def run(uiapp, data, log):
    """
    Highlights pipes using view overrides.
    Requires a transaction in Revit 2020–2024.
    """
    try:
        uidoc = uiapp.ActiveUIDocument
        doc = uidoc.Document
        view = uidoc.ActiveView

        ids = data.get("ids", [])
        if not ids:
            raise Exception("No pipe IDs provided to highlight.")

        log("HIGHLIGHT: Applying view overrides to pipes: {0}".format(ids))

        element_ids = [ElementId(int(x)) for x in ids]

        # Highlight graphics
        ogs = OverrideGraphicSettings()
        ogs.SetProjectionLineColor(Color(255, 0, 0))
        ogs.SetProjectionLineWeight(10)
        ogs.SetSurfaceForegroundPatternColor(Color(255, 200, 200))

        # OPEN TRANSACTION
        t = Transaction(doc, "Highlight Pipes")
        t.Start()

        for eid in element_ids:
            try:
                view.SetElementOverrides(eid, ogs)
            except Exception as inner_e:
                log(" - ERROR highlight {0}: {1}".format(eid.IntegerValue, inner_e))

        t.Commit()

        # RESULT JSON
        result = {
            "status": "ok",
            "highlighted_ids": ids,
            "count": len(ids)
        }

        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)
        with open(RESPONSE_PATH, "w") as f:
            json.dump(result, f, indent=2)

        log("HIGHLIGHT: Completed for {0} pipe(s)".format(len(ids)))

    except Exception as e:
        log("Error in highlight_pipes: {0}".format(e))
        log(traceback.format_exc())
        with open(RESPONSE_PATH, "w") as f:
            json.dump({"error": str(e)}, f, indent=2)

################################################################################
### commands\open_view_by_id.py
################################################################################
# -*- coding: utf-8 -*-
import os
import json
from Autodesk.Revit.DB import ElementId

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")


def run(uiapp, data, log):
    """
    Opens a view in Revit by its element ID.
    """
    try:
        doc = uiapp.ActiveUIDocument.Document
        view_id_int = data.get("id")

        if not view_id_int:
            raise Exception("Missing 'id' field for open-view-by-id")

        # Correct creation of ElementId
        eid = ElementId(view_id_int)
        view_elem = doc.GetElement(eid)

        if not view_elem:
            raise Exception("No view found with id {0}".format(view_id_int))

        # Switch active view
        uiapp.ActiveUIDocument.ActiveView = view_elem

        result = {
            "status": "ok",
            "opened_view_id": view_id_int,
            "opened_view_name": view_elem.Name
        }

        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)

        with open(RESPONSE_PATH, "w") as f:
            json.dump(result, f, indent=2)

        log("Opened view id {0}: {1}".format(view_id_int, view_elem.Name))

    except Exception as e:
        with open(RESPONSE_PATH, "w") as f:
            json.dump({"error": str(e)}, f, indent=2)
        log("Error in open_view_by_id: {0}".format(e))

################################################################################
### commands\select_elements.py
################################################################################
# -*- coding: utf-8 -*-
import os
import json
import traceback
from Autodesk.Revit.DB import ElementId
from System.Collections.Generic import List

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")


def run(uiapp, data, log):
    """
    Selects one or more elements in Revit based on a list of element IDs.
    Expected JSON from BlueTree:
    {
        "ids": [123456, 234567, 345678]
    }
    """
    try:
        uidoc = uiapp.ActiveUIDocument
        doc = uidoc.Document

        ids = data.get("ids")

        if not ids or not isinstance(ids, list):
            raise Exception("Missing or invalid 'ids' list for select-elements")

        log("Selecting elements: {}".format(ids))

        # Convert Python list -> .NET List[ElementId]
        dotnet_ids = List[ElementId]()
        for i in ids:
            try:
                eid = ElementId(int(i))
                if doc.GetElement(eid):
                    dotnet_ids.Add(eid)
                    log(" - Valid element selected: {}".format(i))
                else:
                    log(" - WARNING: No element found with ID {}".format(i))
            except Exception as single_e:
                log(" - ERROR converting ID {}: {}".format(i, single_e))

        # Apply selection
        uidoc.Selection.SetElementIds(dotnet_ids)

        result = {
            "status": "ok",
            "selected_ids": ids,
            "count": len(dotnet_ids)
        }

        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)

        with open(RESPONSE_PATH, "w") as f:
            json.dump(result, f, indent=2)

        log("Selection applied: {} element(s)".format(len(dotnet_ids)))

    except Exception as e:
        tb = traceback.format_exc()
        log("Error in select_elements: {}".format(e))
        log(tb)

        with open(RESPONSE_PATH, "w") as f:
            json.dump({"error": str(e)}, f, indent=2)

################################################################################
### commands\select_pipes_in_current_view.py
################################################################################
# -*- coding: utf-8 -*-
import os
import json
import traceback

from Autodesk.Revit.DB import ElementId, FilteredElementCollector
from Autodesk.Revit.DB import VisibleInViewFilter
from Autodesk.Revit.DB.Plumbing import Pipe
from System.Collections.Generic import List

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")


def run(uiapp, data, log):
    """
    Fast version:
    - Collect only visible Pipes in the current view
    - Intersect with provided IDs
    - Select instantly
    """
    try:
        uidoc = uiapp.ActiveUIDocument
        doc = uidoc.Document
        view = uidoc.ActiveView
        
        ids = data.get("ids", [])
        if not ids:
            raise Exception("No pipe IDs provided.")

        log("FAST MODE: selecting visible pipes from {0}".format(ids))

        # Convert provided IDs into integer set
        target_ids = set(int(x) for x in ids)

        # Build visibility filter
        vis_filter = VisibleInViewFilter(doc, view.Id)

        # Collect ONLY visible pipes (super fast)
        visible_pipes = FilteredElementCollector(doc, view.Id) \
            .OfClass(Pipe) \
            .WherePasses(vis_filter) \
            .ToElements()

        # Extract only matching IDs
        matching_ids = []
        dotnet_ids = List[ElementId]()

        for p in visible_pipes:
            pid = p.Id.IntegerValue
            if pid in target_ids:
                matching_ids.append(pid)
                dotnet_ids.Add(p.Id)

        # Apply selection
        uidoc.Selection.SetElementIds(dotnet_ids)

        result = {
            "status": "ok",
            "selected_ids": matching_ids,
            "count": len(matching_ids)
        }

        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)

        with open(RESPONSE_PATH, "w") as f:
            json.dump(result, f, indent=2)

        log("FAST MODE: selected {0} pipe(s)".format(len(matching_ids)))

    except Exception as e:
        log("FAST ERROR: {0}".format(e))
        log(traceback.format_exc())

        with open(RESPONSE_PATH, "w") as f:
            json.dump({"error": str(e)}, f, indent=2)

################################################################################
### commands\set_pipe_il.py
################################################################################
# -*- coding: utf-8 -*-
import os
import json
import traceback

from Autodesk.Revit.DB import Transaction, ElementId
from Autodesk.Revit.DB.Plumbing import Pipe

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")

MM_TO_FT = 1.0 / 304.8      # mm → feet
FT_TO_MM = 304.8            # feet → mm


def to_ft(val):
    if val is None:
        return None
    return float(val) * MM_TO_FT


def to_mm(val):
    if val is None:
        return None
    return round(val * FT_TO_MM, 3)


def run(uiapp, data, log):
    try:
        uidoc = uiapp.ActiveUIDocument
        doc = uidoc.Document

        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)

        log("=== set_pipe_il.py START ===")

        pipe_id = data.get("pipe_id")
        if not pipe_id:
            raise Exception("No pipe_id provided.")

        # incoming mm values from BlueTree
        il_lower_mm_in = data.get("il_lower_mm")
        il_upper_mm_in = data.get("il_upper_mm")
        h_lower_mm_in = data.get("il_height_lower_mm")
        h_upper_mm_in = data.get("il_height_upper_mm")
        floor_rl_mm_in = data.get("floor_rl_below")

        # convert inputs to feet for Revit
        il_lower_ft = to_ft(il_lower_mm_in)
        il_upper_ft = to_ft(il_upper_mm_in)
        h_lower_ft = to_ft(h_lower_mm_in)
        h_upper_ft = to_ft(h_upper_mm_in)
        floor_rl_ft = to_ft(floor_rl_mm_in)

        log("Updating IL parameters for pipe {}...".format(pipe_id))

        el = doc.GetElement(ElementId(int(pipe_id)))
        if not isinstance(el, Pipe):
            raise Exception("Element {} is not a Pipe.".format(pipe_id))

        applied_feet = {}   # track feet values internally

        t = Transaction(doc, "Set IL Parameters")
        t.Start()

        def set_param(name, ft_value):
            if ft_value is None:
                return
            p = el.LookupParameter(name)
            if p:
                p.Set(ft_value)
                applied_feet[name] = ft_value
                log("Set {} (ft) = {}".format(name, ft_value))
            else:
                log("Parameter '{}' not found.".format(name))

        # update in Revit
        set_param("IL Lower", il_lower_ft)
        set_param("IL Upper", il_upper_ft)
        set_param("IL Height Lower", h_lower_ft)
        set_param("IL Height Upper", h_upper_ft)
        set_param("Floor RL Below", floor_rl_ft)

        t.Commit()

        # Convert all applied feet → mm for return result
        applied_mm = {name: to_mm(val) for name, val in applied_feet.items()}

        result = {
            "status": "ok",
            "pipe_id": int(pipe_id),
            "message": "IL update confirmed",
            "applied_mm": applied_mm
        }

        with open(RESPONSE_PATH, "w") as f:
            json.dump(result, f, indent=2)

        log("IL update completed and confirmed for pipe {}.".format(pipe_id))
        log("=== set_pipe_il.py END ===")

    except Exception as e:
        log("EXCEPTION: {}".format(e))
        log(traceback.format_exc())

        with open(RESPONSE_PATH, "w") as f:
            json.dump({"error": str(e)}, f, indent=2)

################################################################################
### commands\test_command.py
################################################################################

from Autodesk.Revit.UI import TaskDialog

def run(uiapp, data, log):
    try:
        log("Running TEST COMMAND")
        TaskDialog.Show("Test Command", "Test command executed successfully.")  
        log("Test command completed.")
    except Exception as e:
        log("Test command error: {0}".format(e))

################################################################################
### CommandWatcherHelper.py
################################################################################
# -*- coding: utf-8 -*-
import os
import sys
import time
import threading
import json
import importlib
from pyrevit import forms
from Autodesk.Revit.UI import IExternalEventHandler

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
BRIDGE_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Bridge")
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
LOG_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Logs")

class CommandWatcherHandler(IExternalEventHandler):
    """Revit command dispatcher that dynamically loads command modules."""

    def __init__(self, watch_path):
        self.uiapp_cached = None 
        self.event_pending = False
        self.watch_path = watch_path
        self.last_mod_time = None
        self.last_command = None


        self.keep_running = True
        base_dir = os.path.dirname(watch_path)
        self.commands_dir = os.path.join(os.path.dirname(__file__), "commands")
        self.requests_dir = os.path.join(os.path.dirname(__file__), "requests")




        self.log_path = os.path.join(LOG_FOLDER, "revit_pad_log.txt")

        # Ensure commands directory is in import path
        if self.commands_dir not in sys.path:
            sys.path.append(self.commands_dir)

    def log(self, msg):
        try:
            ts = time.strftime("%Y-%m-%d %H:%M:%S")
            with open(self.log_path, "ab") as f:
                f.write(u"[{0}] {1}\n".format(ts, msg).encode("utf-8", "replace"))
        except Exception:
            pass

    def Execute(self, uiapp):

        try:
            if not os.path.exists(self.watch_path):
                return
            
            if os.path.getsize(self.watch_path) < 5:
                return
                
            if self.uiapp_cached is None:
                self.uiapp_cached = uiapp
                self.log("Cached UIApplication")

            mod_time = os.path.getmtime(self.watch_path)
            if mod_time == self.last_mod_time:
                return
            self.last_mod_time = mod_time

            # --- wait for writer to finish ---
            for _ in range(10):
                if os.path.getsize(self.watch_path) > 5:
                    break
                time.sleep(0.05)

            

            with open(self.watch_path, "r") as f:
                data = json.load(f)

            cmd = (data.get("command") or data.get("request") or "").strip()
            if not cmd or cmd == self.last_command:
                return

            self.last_command = cmd
            self.log("Command received: {0}".format(cmd))
            self.run_command(cmd, uiapp, data)

        except Exception as e:
            self.log("Error in Execute: {0}".format(e))

        finally:
            self.event_pending = False


    def run_command(self, cmd, uiapp, data):
        

        try:
            if cmd == "stop_watcher":
                self.log("Received stop_watcher command. Stopping loop.")

                # Remove the lock file
                try:
                    os.remove(os.path.join(BRIDGE_FOLDER, "watcher.lock"))
                    self.log("Watcher lock file removed.")
                except:
                    pass

                # Clear the command file to prevent reprocessing
                try:
                    with open(self.watch_path, "w") as f:
                        f.write("{}")
                    self.log("stop_watcher cleared from JSON file.")
                except:
                    self.log("Failed to clear stop_watcher from JSON file.")

                # Reset last command so nothing lingers
                self.last_command = None

                # Stop the loop
                self.keep_running = False
                return


            module_name = cmd.replace("-", "_")

            if "request" in data:
                module_path = self.requests_dir
            else:
                module_path = self.commands_dir

            sys.path.append(module_path)

            self.log("IMPORTING: {0}".format(module_name))
            module = importlib.import_module(module_name)

            self.log("LOADED FROM: {0}".format(getattr(module, "__file__", "UNKNOWN")))

            # IronPython reload (Python 2 syntax)
            try:
                reload(module)
            except Exception as e:
                self.log("Reload warning: {0}".format(e))

            if hasattr(module, "run"):
                data["watch_path"] = self.watch_path
                module.run(uiapp, data, self.log)

                # NEW: clear file to stop repeats
                try:
                    with open(self.watch_path, "w") as f:
                        f.write("{}")
                    self.log("Command cleared from JSON file.")
                except:
                    self.log("Failed to clear command file.")

                self.last_command = None

        except Exception as e:
            self.log("⚠ Command failed ({0}): {1}".format(cmd, e))
            forms.alert("⚠ Command failed:\n{0}\n\n{1}".format(cmd, e),
                        title="Command Watcher")


    def GetName(self):
        return "Command Watcher Event"

    def start(self, ext_event, interval=3):

        def loop():
            time.sleep(5)
            self.log("Command Watcher active.")

            while True:
                if not self.keep_running:
                    self.log("Watcher loop exiting cleanly.")
                    return  # <-- EXIT THREAD IMMEDIATELY

                # HEARTBEAT
                try:
                    heartbeat_path = os.path.join(BRIDGE_FOLDER, "revit_heartbeat.json")
                    with open(heartbeat_path, "w") as hb:
                        hb.write(json.dumps({"timestamp": time.time(), "status": "alive"}))
                except:
                    pass

                # Raise events
                if not self.event_pending:
                    self.event_pending = True
                    try:
                        ext_event.Raise()
                    except:
                        self.event_pending = False

                # Short sleep for responsive shutdown
                for _ in range(30):   # 30 × 0.1s = 3 seconds total
                    if not self.keep_running:
                        self.log("Watcher loop stopping during sleep.")
                        return
                    time.sleep(0.1)


        t = threading.Thread(target=loop)
        t.daemon = True
        t.start()

################################################################################
### requests\get_3d_views.py
################################################################################
# -*- coding: utf-8 -*-
import os
import json
from Autodesk.Revit.DB import (
    FilteredElementCollector,
    View3D
)

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")


def run(uiapp, data, log):
    """
    Returns all 3D views in the current Revit document.
    Includes id, name, view type, and perspective flag.
    """
    try:
        doc = uiapp.ActiveUIDocument.Document

        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)

        views = []
        collector = FilteredElementCollector(doc).OfClass(View3D)

        for v in collector:
            try:
                # Skip templates
                if v.IsTemplate:
                    continue

                views.append({
                    "id": v.Id.IntegerValue,
                    "name": v.Name,
                    "is_perspective": bool(v.IsPerspective),
                    "view_type": str(v.ViewType)
                })
            except Exception:
                pass

        result = {"views": views}

        with open(RESPONSE_PATH, "w") as f:
            json.dump(result, f, indent=2)

        log("Returned 3D views: {0}".format(len(views)))

    except Exception as e:
        with open(RESPONSE_PATH, "w") as f:
            json.dump({"error": str(e)}, f, indent=2)
        log("Error in get_3d_views: {0}".format(e))

################################################################################
### requests\get_active_view.py
################################################################################
# -*- coding: utf-8 -*-
import os
import json

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")


def run(uiapp, data, log):
    """
    Returns information about the current active view in Revit.
    """
    try:
        doc = uiapp.ActiveUIDocument.Document
        view = doc.ActiveView

        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)

        result = {
            "view_name": view.Name,
            "view_id": view.Id.IntegerValue,
            "view_type": str(view.ViewType)
        }

        with open(RESPONSE_PATH, "w") as f:
            json.dump(result, f, indent=2)

        log("Returned active view information: {0}".format(view.Name))

    except Exception as e:
        # Return error in response.json
        with open(RESPONSE_PATH, "w") as f:
            json.dump({"error": str(e)}, f, indent=2)
        log("Error in get_active_view: {0}".format(e))

################################################################################
### requests\get_all_views.py
################################################################################
# -*- coding: utf-8 -*-
import os
import json
from Autodesk.Revit.DB import (
    FilteredElementCollector,
    View
)

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")


def run(uiapp, data, log):
    """
    Returns ALL non-template views in the model.
    Grouped by general view type.
    """
    try:
        doc = uiapp.ActiveUIDocument.Document

        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)

        # Prepare container for grouping
        views_by_type = {}

        collector = FilteredElementCollector(doc).OfClass(View)

        for v in collector:
            try:
                if v.IsTemplate:
                    continue

                vtype = str(v.ViewType)

                if vtype not in views_by_type:
                    views_by_type[vtype] = []

                views_by_type[vtype].append({
                    "id": v.Id.IntegerValue,
                    "name": v.Name,
                    "view_type": vtype
                })

            except Exception:
                pass

        result = {"views": views_by_type}

        with open(RESPONSE_PATH, "w") as f:
            json.dump(result, f, indent=2)

        log("Returned all views grouped by type.")

    except Exception as e:
        # Return error
        with open(RESPONSE_PATH, "w") as f:
            json.dump({"error": str(e)}, f, indent=2)

        log("Error in get_all_views: {0}".format(e))

################################################################################
### requests\get_highlighted_pipes.py
################################################################################
# -*- coding: utf-8 -*-
import os
import json
import traceback

import Autodesk.Revit.DB as DB
from Autodesk.Revit.DB.Plumbing import Pipe

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")


def safe_color_tuple(c):
    """
    Safely returns (R,G,B) or None if color is invalid/uninitialized.
    """
    try:
        return (c.Red, c.Green, c.Blue)
    except:
        return None


def run(uiapp, data, log):
    """
    Detects ONLY pipes highlighted using your highlight_pipes_temp overrides.
    """
    try:
        uidoc = uiapp.ActiveUIDocument
        doc = uidoc.Document
        view = uidoc.ActiveView

        log("=== GET HIGHLIGHTED PIPES: START ===")

        highlighted_ids = []

        # Values used by highlight command
        HL_LINE_COLOR = (255, 0, 0)
        HL_SURF_COLOR = (255, 200, 200)
        HL_LINE_WEIGHT = 10

        collector = DB.FilteredElementCollector(doc, view.Id).OfClass(Pipe)

        for p in collector:
            eid = p.Id
            ogs = view.GetElementOverrides(eid)

            # Extract overrides safely
            proj_color = safe_color_tuple(ogs.ProjectionLineColor)
            surf_color = safe_color_tuple(ogs.SurfaceForegroundPatternColor)
            lw = ogs.ProjectionLineWeight

            # A pipe is highlighted if ANY of the applied override values match
            is_highlighted = False

            if proj_color == HL_LINE_COLOR:
                is_highlighted = True

            if surf_color == HL_SURF_COLOR:
                is_highlighted = True

            if lw == HL_LINE_WEIGHT:
                is_highlighted = True

            if is_highlighted:
                highlighted_ids.append(eid.IntegerValue)

            # DEBUG LOGGING
            log("Pipe {0} → proj:{1} surf:{2} lw:{3} highlighted:{4}"
                .format(eid.IntegerValue, proj_color, surf_color, lw, is_highlighted))

        # Output result JSON
        result = {
            "status": "ok",
            "highlighted_ids": highlighted_ids,
            "count": len(highlighted_ids)
        }

        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)

        with open(RESPONSE_PATH, "w") as f:
            json.dump(result, f, indent=2)

        log("=== GET HIGHLIGHTED PIPES: FOUND {0} ===".format(len(highlighted_ids)))

    except Exception as e:
        log("Error in get_highlighted_pipes: {0}".format(e))
        log(traceback.format_exc())
        try:
            with open(RESPONSE_PATH, "w") as f:
                json.dump({"error": str(e)}, f, indent=2)
        except:
            pass

################################################################################
### requests\get_model_path.py
################################################################################
# -*- coding: utf-8 -*-
import os, json
from Autodesk.Revit.DB import ModelPathUtils

DATA_FOLDER = r"C:\PADApps\RevitPAD\Data"
RESPONSE = os.path.join(DATA_FOLDER, "response.json")

def run(uiapp, data, log):
    try:
        doc = uiapp.ActiveUIDocument.Document

        # Get absolute model path
        model_path = doc.PathName

        # Detect parent folder
        parent = os.path.dirname(model_path) if model_path else ""

        result = {
            "model_path": model_path,
            "parent_folder": parent,
        }

        # Persist response
        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)

        with open(RESPONSE, "w") as f:
            json.dump(result, f, indent=2)

        log("Returned model path → {0}".format(model_path))

    except Exception as e:
        log("Error in get_model_path: {0}".format(e))

################################################################################
### requests\get_pipe_elevations.py
################################################################################
# -*- coding: utf-8 -*-
import os
import json
import traceback

from Autodesk.Revit.DB import (
    FilteredElementCollector,
    VisibleInViewFilter,
    BuiltInCategory
)
from Autodesk.Revit.DB.Plumbing import Pipe

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")

FT_TO_MM = 304.8   # Revit internal → mm


def mm(val):
    """Convert feet → mm with 3-decimal rounding."""
    if val is None:
        return None
    return round(val * FT_TO_MM, 3)


def run(uiapp, data, log):
    try:
        uidoc = uiapp.ActiveUIDocument
        doc = uidoc.Document
        view = uidoc.ActiveView

        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)

        log("Starting get_pipe_elevations...")

        # ================================================================
        # MODE SELECTION
        # ================================================================
        mode = data.get("mode", "selected")  # "selected" or "all_in_view"
        pipes_data = []
        pipe_elements = []

        # ---------------------------------------------------------------
        # MODE 1 — GET ALL VISIBLE PIPES IN VIEW
        # ---------------------------------------------------------------
        if mode == "all_in_view":
            log("Collecting ALL visible pipes in current view...")

            vis_filter = VisibleInViewFilter(doc, view.Id)

            pipe_elements = (
                FilteredElementCollector(doc, view.Id)
                .OfCategory(BuiltInCategory.OST_PipeCurves)
                .WherePasses(vis_filter)
                .ToElements()
            )

            log("Found {} visible pipes.".format(len(pipe_elements)))

        # ---------------------------------------------------------------
        # MODE 2 — GET SELECTED PIPES (original behavior)
        # ---------------------------------------------------------------
        else:
            sel_ids = uidoc.Selection.GetElementIds()
            if not sel_ids or len(sel_ids) == 0:
                raise Exception("No pipes selected.")

            log("Selected items: {}".format(len(sel_ids)))
            pipe_elements = [doc.GetElement(x) for x in sel_ids]

        # ================================================================
        # ITERATE AND EXTRACT PIPE DATA
        # ================================================================
        for el in pipe_elements:
            if not isinstance(el, Pipe):
                continue

            eid = el.Id.IntegerValue
            log("Processing pipe ID: {}".format(eid))

            # ------------------------------------------------------------
            # 1. GEOMETRIC START/END ELEVATIONS
            # ------------------------------------------------------------
            conns = el.ConnectorManager.Connectors
            all_conns = [c for c in conns]

            if len(all_conns) < 2:
                log("Pipe has <2 connectors. Skipping.")
                continue

            start = all_conns[0].Origin
            end = all_conns[1].Origin

            start_z = mm(start.Z)
            end_z = mm(end.Z)

            # ------------------------------------------------------------
            # 2. DIAMETERS
            # ------------------------------------------------------------
            od = idm = wt = None

            p_od = el.LookupParameter("Outside Diameter")
            if p_od:
                od = mm(p_od.AsDouble())

            p_id = el.LookupParameter("Inside Diameter")
            if p_id:
                idm = mm(p_id.AsDouble())

            if od is not None and idm is not None:
                wt = round((od - idm) / 2.0, 3)

            # ------------------------------------------------------------
            # 3. LENGTH (mm)
            # ------------------------------------------------------------
            length = None
            p_len = el.LookupParameter("Length")
            if p_len:
                length = mm(p_len.AsDouble())

            # ------------------------------------------------------------
            # 4. SLOPE (%)
            # ------------------------------------------------------------
            slope_percent = None
            if length and length != 0:
                slope_percent = round(((start_z - end_z) / length) * 100, 2)

            # ------------------------------------------------------------
            # 5. SYSTEM TYPE / NAME
            # ------------------------------------------------------------
            system_type = None
            system_name = None
            if el.MEPSystem:
                system_type = el.MEPSystem.SystemType.ToString()
                system_name = el.MEPSystem.Name

            # ------------------------------------------------------------
            # 6. MATERIAL
            # ------------------------------------------------------------
            material = None
            p_mat = el.LookupParameter("Material")
            if p_mat:
                material = p_mat.AsString()

            # ------------------------------------------------------------
            # 7. REFERENCE LEVEL + RL
            # ------------------------------------------------------------
            reference_level_name = None
            reference_level_rl_mm = None

            ref_level = el.ReferenceLevel
            if ref_level:
                reference_level_name = ref_level.Name
                reference_level_rl_mm = mm(ref_level.Elevation)

            # ------------------------------------------------------------
            # 8. INVERT PARAMETERS
            # ------------------------------------------------------------
            def get_param_mm(name):
                p = el.LookupParameter(name)
                return mm(p.AsDouble()) if p else None

            il_lower = get_param_mm("IL Lower")
            il_upper = get_param_mm("IL Upper")
            il_height_lower = get_param_mm("IL Height Lower")
            il_height_upper = get_param_mm("IL Height Upper")
            floor_rl_below = get_param_mm("Floor RL Below")

            # ------------------------------------------------------------
            # STORE RESULT
            # ------------------------------------------------------------
            pipes_data.append({
                "element_id": eid,
                "start_elev_mm": start_z,
                "end_elev_mm": end_z,
                "slope_percent": slope_percent,
                "outside_diameter_mm": od,
                "inside_diameter_mm": idm,
                "wall_thickness_mm": wt,
                "length_mm": length,
                "system_type": system_type,
                "system_name": system_name,
                "material": material,
                "reference_level_name": reference_level_name,
                "reference_level_rl_mm": reference_level_rl_mm,

                "il_lower_mm": il_lower,
                "il_upper_mm": il_upper,
                "il_height_lower_mm": il_height_lower,
                "il_height_upper_mm": il_height_upper,
                "floor_rl_below_mm": floor_rl_below,
            })

        # ================================================================
        # WRITE RESULT
        # ================================================================
        result = {"status": "ok", "pipes": pipes_data}

        with open(RESPONSE_PATH, "w") as f:
            json.dump(result, f, indent=2)

        log("Pipe elevation data written successfully.")
        log("Completed get_pipe_elevations.")

    except Exception as e:
        log("EXCEPTION in get_pipe_elevations: {}".format(e))
        log(traceback.format_exc())

        with open(RESPONSE_PATH, "w") as f:
            json.dump({"error": str(e)}, f, indent=2)

################################################################################
### requests\get_pipe_ids.py
################################################################################
# -*- coding: utf-8 -*-
import os
import json
import traceback
from Autodesk.Revit.DB import *
from Autodesk.Revit.UI.Selection import ObjectType, ISelectionFilter

# Needed to use .NET List for SetElementIds
import clr
clr.AddReference("System")
from System.Collections.Generic import List

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")


class PipeSelectionFilter(ISelectionFilter):
    def AllowElement(self, e):
        from Autodesk.Revit.DB.Plumbing import Pipe
        return isinstance(e, Pipe)

    def AllowReference(self, ref, point):
        return True


def write_debug(log, msg):
    try:
        log("[DEBUG get_pipe_ids] " + msg)
    except:
        pass


def run(uiapp, data, log):
    write_debug(log, "=== get_pipe_ids.py START ===")

    uidoc = uiapp.ActiveUIDocument
    doc = uidoc.Document

    try:
        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)

        write_debug(log, "ActiveView: {}".format(uidoc.ActiveView.Name))
        write_debug(log, "About to call PickObjects...")

        # ======================================================================
        # MULTI-SELECTION
        # ======================================================================
        refs = uidoc.Selection.PickObjects(
            ObjectType.Element,
            PipeSelectionFilter(),
            "Select one or more pipes"
        )

        write_debug(log, "PickObjects returned {} references".format(len(refs)))

        pipe_ids = []
        for r in refs:
            try:
                eid = r.ElementId
                el = doc.GetElement(eid)
                if el:
                    pid = el.Id.IntegerValue
                    pipe_ids.append(pid)
                    write_debug(log, "  - Picked Pipe ID: {}".format(pid))
                else:
                    write_debug(log, "  - WARNING: doc.GetElement returned None")
            except Exception as inner_e:
                write_debug(log, "  - ERROR processing reference: {}".format(inner_e))

        # ======================================================================
        # WRITE RESPONSE
        # ======================================================================
        result = {"status": "ok", "pipe_ids": pipe_ids}
        with open(RESPONSE_PATH, "w") as f:
            json.dump(result, f, indent=2)

        write_debug(log, "Response written successfully.")
        write_debug(log, "Pipe IDs: {}".format(pipe_ids))

        # ======================================================================
        # CLEAR REVIT SELECTION
        # ======================================================================
        try:
            empty = List[ElementId]()   # empty .NET list
            uidoc.Selection.SetElementIds(empty)
            write_debug(log, "Revit selection cleared successfully.")
        except Exception as clear_e:
            write_debug(log, "ERROR clearing selection: {}".format(clear_e))

    except Exception as e:
        tb = traceback.format_exc()
        write_debug(log, "EXCEPTION TRIGGERED DURING PICK")
        write_debug(log, "Exception: {}".format(e))
        write_debug(log, "Traceback: {}".format(tb))

        # Write error response
        err = {"error": str(e)}
        with open(RESPONSE_PATH, "w") as f:
            json.dump(err, f, indent=2)

        log("Error in get_pipe_ids: {}".format(e))

    write_debug(log, "=== get_pipe_ids.py END ===")

################################################################################
### requests\get_pipe_info.py
################################################################################
# -*- coding: utf-8 -*-
import os
import json
import traceback

from Autodesk.Revit.DB import (
    FilteredElementCollector,
    VisibleInViewFilter,
    BuiltInCategory
)
from Autodesk.Revit.DB.Plumbing import Pipe

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")

FT_TO_MM = 304.8   # Revit internal → mm


def mm(val):
    """Convert feet → mm with 3-decimal rounding."""
    if val is None:
        return None
    return round(val * FT_TO_MM, 3)


def run(uiapp, data, log):
    try:
        uidoc = uiapp.ActiveUIDocument
        doc = uidoc.Document
        view = uidoc.ActiveView

        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)

        log("Starting get_pipe_info...")

        # ================================================================
        # MODE SELECTION
        # ================================================================
        mode = data.get("mode", "selected")  # "selected" or "all_in_view"
        pipes_data = []
        pipe_elements = []

        # ---------------------------------------------------------------
        # MODE 1 — GET ALL VISIBLE PIPES IN VIEW
        # ---------------------------------------------------------------
        if mode == "all_in_view":
            log("Collecting ALL visible pipes in current view...")

            vis_filter = VisibleInViewFilter(doc, view.Id)

            pipe_elements = (
                FilteredElementCollector(doc, view.Id)
                .OfCategory(BuiltInCategory.OST_PipeCurves)
                .WherePasses(vis_filter)
                .ToElements()
            )

            log("Found {} visible pipes.".format(len(pipe_elements)))

        # ---------------------------------------------------------------
        # MODE 2 — GET SELECTED PIPES (original behavior)
        # ---------------------------------------------------------------
        else:
            sel_ids = uidoc.Selection.GetElementIds()
            if not sel_ids or len(sel_ids) == 0:
                raise Exception("No pipes selected.")

            log("Selected items: {}".format(len(sel_ids)))
            pipe_elements = [doc.GetElement(x) for x in sel_ids]

        # ================================================================
        # ITERATE AND EXTRACT PIPE DATA
        # ================================================================
        for el in pipe_elements:
            if not isinstance(el, Pipe):
                continue

            eid = el.Id.IntegerValue
            log("Processing pipe ID: {}".format(eid))

            # ------------------------------------------------------------
            # 1. GEOMETRIC START/END ELEVATIONS
            # ------------------------------------------------------------
            conns = el.ConnectorManager.Connectors
            all_conns = [c for c in conns]

            if len(all_conns) < 2:
                log("Pipe has <2 connectors. Skipping.")
                continue

            start = all_conns[0].Origin
            end = all_conns[1].Origin

            start_z = mm(start.Z)
            end_z = mm(end.Z)

            # ------------------------------------------------------------
            # 2. DIAMETERS
            # ------------------------------------------------------------
            od = idm = wt = None

            p_od = el.LookupParameter("Outside Diameter")
            if p_od:
                od = mm(p_od.AsDouble())

            p_id = el.LookupParameter("Inside Diameter")
            if p_id:
                idm = mm(p_id.AsDouble())

            if od is not None and idm is not None:
                wt = round((od - idm) / 2.0, 3)

            # ------------------------------------------------------------
            # 3. LENGTH (mm)
            # ------------------------------------------------------------
            length = None
            p_len = el.LookupParameter("Length")
            if p_len:
                length = mm(p_len.AsDouble())

            # ------------------------------------------------------------
            # 4. SLOPE (%)
            # ------------------------------------------------------------
            slope_percent = None
            if length and length != 0:
                slope_percent = round(((start_z - end_z) / length) * 100, 2)

            # ------------------------------------------------------------
            # 5. SYSTEM TYPE / NAME
            # ------------------------------------------------------------
            system_type = None
            system_name = None
            if el.MEPSystem:
                system_type = el.MEPSystem.SystemType.ToString()
                system_name = el.MEPSystem.Name

            # ------------------------------------------------------------
            # 6. MATERIAL
            # ------------------------------------------------------------
            material = None
            p_mat = el.LookupParameter("Material")
            if p_mat:
                material = p_mat.AsString()

            # ------------------------------------------------------------
            # STORE RESULT
            # ------------------------------------------------------------
            pipes_data.append({
                "element_id": eid,
                "slope_percent": slope_percent,
                "outside_diameter_mm": od,
                "inside_diameter_mm": idm,
                "wall_thickness_mm": wt,
                "length_mm": length,
                "system_type": system_type,
                "system_name": system_name,
                "material": material,

            })

        # ================================================================
        # WRITE RESULT
        # ================================================================
        result = {"status": "ok", "pipes": pipes_data}

        with open(RESPONSE_PATH, "w") as f:
            json.dump(result, f, indent=2)

        log("Pipe info data written successfully.")
        log("Completed get_pipe_info.")

    except Exception as e:
        log("EXCEPTION in get_pipe_info: {}".format(e))
        log(traceback.format_exc())

        with open(RESPONSE_PATH, "w") as f:
            json.dump({"error": str(e)}, f, indent=2)

################################################################################
### requests\get_pipes_with_tags.py
################################################################################
# coding: utf-8

import os
import json
import traceback

from Autodesk.Revit.DB import (
    FilteredElementCollector,
    IndependentTag,
    ElementId,
    VisibleInViewFilter,
    LinkElementId
)
from Autodesk.Revit.DB.Plumbing import Pipe

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")


def write_debug(log, msg):
    try:
        log("[DEBUG get_pipes_with_tags] " + msg)
    except:
        pass


def resolve_tagged_element_ids(tag, doc, log):
    """Return a list of ElementId objects referenced by a tag."""
    ids = []

    if not hasattr(tag, "GetTaggedElementIds"):
        return ids

    try:
        refs = tag.GetTaggedElementIds()
    except:
        return ids

    for ref in refs:
        # Try linked element id first
        try:
            linked_id = ref.LinkedElementId
            if linked_id and linked_id.IntegerValue > 0:
                ids.append(linked_id)
                continue
        except:
            pass

        # Try ElementId next
        try:
            eid = ref.ElementId
            if eid and eid.IntegerValue > 0:
                ids.append(eid)
                continue
        except:
            pass

        write_debug(log, "Unhandled reference: {}".format(ref))

    return ids


def run(uiapp, data, log):
    write_debug(log, "=== get_pipes_with_tags.py START ===")

    try:
        uidoc = uiapp.ActiveUIDocument
        doc = uidoc.Document
        view = uidoc.ActiveView

        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)

        write_debug(log, "Scanning current view for pipe tags...")

        vis_filter = VisibleInViewFilter(doc, view.Id)

        tags = FilteredElementCollector(doc, view.Id) \
            .OfClass(IndependentTag) \
            .WherePasses(vis_filter) \
            .ToElements()

        write_debug(log, "Found {} tags visible in current view".format(len(tags)))

        pipe_ids = set()

        for tag in tags:
            ids = resolve_tagged_element_ids(tag, doc, log)

            for eid in ids:
                if eid and eid.IntegerValue > 0:
                    el = doc.GetElement(eid)
                    if isinstance(el, Pipe):
                        pipe_ids.add(eid.IntegerValue)

        final_ids = sorted(pipe_ids)
        write_debug(log, "Pipes with tags in current view: {}".format(final_ids))

        result = {"status": "ok", "pipe_ids": final_ids}

        with open(RESPONSE_PATH, "w") as f:
            json.dump(result, f, indent=2)

        write_debug(log, "Response written successfully.")

    except Exception as e:
        write_debug(log, "EXCEPTION: {}".format(e))
        write_debug(log, traceback.format_exc())

        with open(RESPONSE_PATH, "w") as f:
            json.dump({"error": str(e)}, f, indent=2)

    write_debug(log, "=== get_pipes_with_tags.py END ===")

################################################################################
### requests\get_sheet_data.py
################################################################################
# -*- coding: utf-8 -*-
import os
import json
from Autodesk.Revit.DB import (
    FilteredElementCollector,
    BuiltInCategory,
    BuiltInParameter,
    Revision
)

REVIT_PAD_FOLDER = r"C:\PADApps\RevitPAD"
DATA_FOLDER = os.path.join(REVIT_PAD_FOLDER, "Data")
RESPONSE_PATH = os.path.join(DATA_FOLDER, "response.json")


def run(uiapp, data, log):
    """
    Request handler: returns all Revit sheets and revision metadata.
    Writes output to response.json for BlueTree to read.
    """
    try:
        doc = uiapp.ActiveUIDocument.Document

        if not os.path.exists(DATA_FOLDER):
            os.makedirs(DATA_FOLDER)

        sheets_out = []

        collector = FilteredElementCollector(doc).OfCategory(
            BuiltInCategory.OST_Sheets
        )

        for s in collector:
            try:
                # --- Current revision number ---
                rev_param = s.get_Parameter(BuiltInParameter.SHEET_CURRENT_REVISION)
                current_rev_num = rev_param.AsString() if rev_param else None
                if not current_rev_num:
                    current_rev_num = None

                rev_desc = None
                rev_date = None

                # --- Match the Revision element ---
                if current_rev_num:
                    for rev_id in s.GetAllRevisionIds():
                        rev = doc.GetElement(rev_id)
                        if isinstance(rev, Revision) and rev.RevisionNumber == current_rev_num:
                            rev_desc = rev.Description
                            rev_date = rev.RevisionDate
                            break

                sheets_out.append({
                    "id": s.Id.IntegerValue,
                    "sheet_number": s.SheetNumber,
                    "sheet_name": s.Name,
                    "revision_number": current_rev_num,
                    "revision_description": rev_desc,
                    "revision_date": rev_date
                })

            except Exception:
                pass

        # --- Write request result ---
        result = {"sheets": sheets_out}

        with open(RESPONSE_PATH, "w") as f:
            json.dump(result, f, indent=2)

        log("Returned sheet data: {0} sheets".format(len(sheets_out)))

    except Exception as e:
        log("Error in get_sheet_data: {0}".format(e))
